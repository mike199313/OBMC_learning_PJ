From 1637bd0140061806ba97f763a2be36a5a3d17cd5 Mon Sep 17 00:00:00 2001
From: Tommy Lin <lin.tommysc@inventec.com>
Date: Thu, 10 Mar 2022 07:25:59 +0000
Subject: [PATCH 1/6] Fix-Fan-and-Powersupply-path

---
 src/store/modules/HardwareStatus/FanStore.js  | 26 ++++++++++++++++---
 .../Inventory/InventoryTableFans.vue          |  2 +-
 2 files changed, 24 insertions(+), 4 deletions(-)

diff --git a/src/store/modules/HardwareStatus/FanStore.js b/src/store/modules/HardwareStatus/FanStore.js
index fca1f32..43c6eea 100644
--- a/src/store/modules/HardwareStatus/FanStore.js
+++ b/src/store/modules/HardwareStatus/FanStore.js
@@ -38,10 +38,30 @@ const FanStore = {
     },
   },
   actions: {
-    async getFanInfo({ commit }) {
+    async getChassisCollection() {
       return await api
-        .get('/redfish/v1/Chassis/chassis/Thermal')
-        .then(({ data: { Fans = [] } }) => commit('setFanInfo', Fans))
+        .get('/redfish/v1/Chassis')
+        .then(({ data: { Members } }) =>
+          Members.map((member) => member['@odata.id'])
+        )
+        .catch((error) => console.log(error));
+    },
+    async getAllFans({ dispatch, commit }) {
+      const collection = await dispatch('getChassisCollection');
+      if (!collection) return;
+      return await api
+        .all(collection.map((chassis) => dispatch('getChassisFan', chassis)))
+        .then((fans_) => {
+          let fansList = [];
+          fans_.forEach((fan) => (fansList = [...fansList, ...fan]));
+          commit('setFanInfo', fansList);
+        })
+        .catch((error) => console.log(error));
+    },
+    async getChassisFan(_, id) {
+      return await api
+        .get(`${id}/Thermal`)
+        .then(({ data: { Fans } }) => Fans || [])
         .catch((error) => console.log(error));
     },
   },
diff --git a/src/views/HardwareStatus/Inventory/InventoryTableFans.vue b/src/views/HardwareStatus/Inventory/InventoryTableFans.vue
index fe788c5..ff81ee6 100644
--- a/src/views/HardwareStatus/Inventory/InventoryTableFans.vue
+++ b/src/views/HardwareStatus/Inventory/InventoryTableFans.vue
@@ -170,7 +170,7 @@ export default {
     },
   },
   created() {
-    this.$store.dispatch('fan/getFanInfo').finally(() => {
+    this.$store.dispatch('fan/getAllFans').finally(() => {
       // Emit initial data fetch complete to parent component
       this.$root.$emit('hardware-status-fans-complete');
       this.isBusy = false;
-- 
2.33.0

