From d6d98811d1d607dd80c7c3845722249e75cfab25 Mon Sep 17 00:00:00 2001
From: link <link@inventec.com>
Date: Tue, 10 Aug 2021 01:04:10 +0000
Subject: [PATCH 3/5] Adding moving average method (length=2) for thermal

---
 pid/zone.cpp | 6 ++++--
 pid/zone.hpp | 1 +
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/pid/zone.cpp b/pid/zone.cpp
index f42b05e..7238d33 100644
--- a/pid/zone.cpp
+++ b/pid/zone.cpp
@@ -369,14 +369,14 @@ void DbusPidZone::updateSensors(void)
     using namespace std::chrono;
     /* margin and temp are stored as temp */
     tstamp now = high_resolution_clock::now();
-
     for (const auto& t : _thermalInputs)
     {
         auto sensor = _mgr.getSensor(t);
         ReadReturn r = sensor->read();
         int64_t timeout = sensor->getTimeout();
 
-        _cachedValuesByName[t] = r.value;
+        _cachedValuesByName[t] = (r.value + _previousValuesByName[t]) / 2;
+	_previousValuesByName[t] = r.value;
         tstamp then = r.updated;
 
         auto duration = duration_cast<std::chrono::seconds>(now - then).count();
@@ -410,6 +410,7 @@ void DbusPidZone::initializeCache(void)
     for (const auto& f : _fanInputs)
     {
         _cachedValuesByName[f] = 0;
+	_previousValuesByName[f] = 0;
 
         // Start all fans in fail-safe mode.
         _failSafeSensors.insert(f);
@@ -418,6 +419,7 @@ void DbusPidZone::initializeCache(void)
     for (const auto& t : _thermalInputs)
     {
         _cachedValuesByName[t] = 0;
+	_previousValuesByName[t] = 0;
 
         // Start all sensors in fail-safe mode.
         _failSafeSensors.insert(t);
diff --git a/pid/zone.hpp b/pid/zone.hpp
index 01dc62e..9f405f5 100644
--- a/pid/zone.hpp
+++ b/pid/zone.hpp
@@ -109,6 +109,7 @@ class DbusPidZone : public ZoneInterface, public ModeObject
     std::vector<double> _RPMCeilings;
     std::vector<std::string> _fanInputs;
     std::vector<std::string> _thermalInputs;
+    std::map<std::string, double> _previousValuesByName;
     std::map<std::string, double> _cachedValuesByName;
     const SensorManager& _mgr;
 
-- 
2.33.0

