From 9d367e8b12c593cd371e7c8e492ca6ed7d7fdb8e Mon Sep 17 00:00:00 2001
From: Tommy Lin <lin.tommysc@inventec.com>
Date: Tue, 11 Jan 2022 05:40:17 +0000
Subject: [PATCH 03/17] Fix invalid ldap server uri causing internal server
 error

---
 redfish-core/lib/account_service.hpp | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/redfish-core/lib/account_service.hpp b/redfish-core/lib/account_service.hpp
index 0e15f31e..c2b2dc12 100644
--- a/redfish-core/lib/account_service.hpp
+++ b/redfish-core/lib/account_service.hpp
@@ -25,6 +25,14 @@
 #include <sdbusplus/asio/property.hpp>
 #include <utils/json_utils.hpp>
 
+#include <variant>
+
+#define STR_LEN(s)              (sizeof(s)-1)
+#define LDAP_URL_PREFIX         "ldap://"
+#define LDAP_URL_PREFIX_LEN     STR_LEN(LDAP_URL_PREFIX)
+#define LDAPS_URL_PREFIX        "ldaps://"
+#define LDAPS_URL_PREFIX_LEN    STR_LEN(LDAPS_URL_PREFIX)
+
 namespace redfish
 {
 
@@ -632,6 +640,14 @@ inline void handleServiceAddressPatch(
     const std::string& ldapServerElementName,
     const std::string& ldapConfigObject)
 {
+    std::string serviceAddressFront = serviceAddressList.front();
+    if ((strncasecmp(serviceAddressFront.c_str(), LDAP_URL_PREFIX, LDAP_URL_PREFIX_LEN) != 0)
+            && (strncasecmp(serviceAddressFront.c_str(), LDAPS_URL_PREFIX, LDAPS_URL_PREFIX_LEN) != 0))
+    {
+            messages::propertyValueNotInList(asyncResp->res, serviceAddressFront, "ServiceAddresses");
+            return;
+    }
+
     crow::connections::systemBus->async_method_call(
         [asyncResp, ldapServerElementName,
          serviceAddressList](const boost::system::error_code ec) {
-- 
2.33.0

